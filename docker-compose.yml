version: '3.8'

# Hybrid Docker Compose Configuration
# Combines DVC pipeline orchestration with modular service architecture
# Supports: dvc repro (orchestrated), individual services, and interactive development

services:
  # ============================================================================
  # DATA PIPELINE SERVICES
  # ============================================================================

  # DVC Pipeline Orchestrator - Runs ML pipeline only (without drift detection)
  # Execute all stages in correct order with: docker-compose run dvc-pipeline
  dvc-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-dvc-orchestrator
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
      - ./.dvc:/app/.dvc
      - ./.git:/app/.git
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DVC_NO_ANALYTICS=1
    command: dvc repro --single-item evaluate
    networks:
      - ml-network
    profiles:
      - pipeline

  # DVC Full Pipeline Orchestrator - Runs complete pipeline including drift detection
  # Execute all stages (ML + drift) with: docker-compose run dvc-full-pipeline
  dvc-full-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-dvc-full-orchestrator
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
      - ./.dvc:/app/.dvc
      - ./.git:/app/.git
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DVC_NO_ANALYTICS=1
    command: dvc repro
    networks:
      - ml-network
    profiles:
      - pipeline

  # DVC Drift-Only Pipeline - Runs drift detection stages only (simulate, detect, visualize)
  # Requires trained model. Execute with: docker-compose run dvc-drift-pipeline
  dvc-drift-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-dvc-drift-orchestrator
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
      - ./.dvc:/app/.dvc
      - ./.git:/app/.git
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DVC_NO_ANALYTICS=1
    command: dvc repro --single-item visualize_drift
    networks:
      - ml-network
    profiles:
      - drift
    depends_on:
      - dvc-pull

  # DVC Pull - Fetch data/models from remote storage
  dvc-pull:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-dvc-pull
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./.dvc:/app/.dvc
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - DVC_NO_ANALYTICS=1
    command: dvc pull
    networks:
      - ml-network

  # ============================================================================
  # INDIVIDUAL PIPELINE STAGES (can run independently or via DVC)
  # ============================================================================

  # EDA Pipeline - Exploratory Data Analysis
  eda-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-eda
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
      - ./.dvc:/app/.dvc
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/run_eda.py
    networks:
      - ml-network
    depends_on:
      - dvc-pull
    profiles:
      - manual

  # ML Training Pipeline - Train and evaluate models
  ml-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-train
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
      - ./.dvc:/app/.dvc
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/run_ml.py
    networks:
      - ml-network
    depends_on:
      - dvc-pull
      - eda-pipeline
    profiles:
      - manual

  # Dataset Comparison - Validate and compare datasets
  compare:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-compare
    volumes:
      - ./data:/app/data
      - ./.dvc:/app/.dvc
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/compare_datasets.py
    networks:
      - ml-network
    depends_on:
      - dvc-pull
    profiles:
      - manual

  # Data Visualization - Generate exploratory plots
  visualize:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-visualize
    volumes:
      - ./data:/app/data
      - ./reports:/app/reports
      - ./.dvc:/app/.dvc
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/generate_visualizations.py
    networks:
      - ml-network
    depends_on:
      - dvc-pull
    profiles:
      - manual

  # ============================================================================
  # DRIFT DETECTION SERVICES (Manual - Alternative to DVC Orchestration)
  # ============================================================================
  # Note: For automated drift detection via DVC, use 'dvc-drift-pipeline' service above
  # These services allow manual control over individual drift detection steps

  # Drift Simulation - Generate synthetic drifted dataset (Manual)
  # Alternative: docker-compose run dvc-drift-pipeline (uses DVC orchestration)
  simulate-drift:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-simulate-drift
    volumes:
      - ./data:/app/data
      - ./reports:/app/reports
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/simulate_drift.py
    networks:
      - ml-network
    depends_on:
      - dvc-pull
    profiles:
      - drift-manual

  # Drift Detection - Detect data drift and generate alerts (Manual)
  # Alternative: docker-compose run dvc-drift-pipeline (uses DVC orchestration)
  detect-drift:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-detect-drift
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./mlruns:/app/mlruns
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/detect_drift.py
    networks:
      - ml-network
    depends_on:
      - simulate-drift
    profiles:
      - drift-manual

  # Drift Visualization - Generate drift analysis plots (Manual)
  # Alternative: docker-compose run dvc-drift-pipeline (uses DVC orchestration)
  visualize-drift:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-visualize-drift
    volumes:
      - ./data:/app/data
      - ./reports:/app/reports
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: python scripts/visualize_drift.py
    networks:
      - ml-network
    depends_on:
      - detect-drift
    profiles:
      - drift-manual

  # ============================================================================
  # TESTING SERVICES
  # ============================================================================

  # Unit Tests - Run test suite
  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-test
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./mlruns:/app/mlruns
      - ./tests:/app/tests
    environment:
      - PYTHONUNBUFFERED=1
    command: pytest tests/ -v --tb=short --cov=src
    networks:
      - ml-network
    profiles:
      - test

  # ============================================================================
  # API & MONITORING SERVICES
  # ============================================================================

  # FastAPI Service - Model serving and predictions
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-api
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models:ro
      - ./mlruns:/app/mlruns:ro
      - ./src/api:/app/src/api
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - ml-network
    depends_on:
      - dvc-pull
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - services

  # MLflow Tracking Server - Experiment tracking and management
  mlflow:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-mlflow
    ports:
      - "5001:5001"
    volumes:
      - ./mlruns:/app/mlruns
    environment:
      - PYTHONUNBUFFERED=1
    command: mlflow ui --host 0.0.0.0 --port 5001 --backend-store-uri file:///app/mlruns
    networks:
      - ml-network
    profiles:
      - services

  # ============================================================================
  # DEVELOPMENT SERVICES
  # ============================================================================

  # Interactive Shell - For debugging and development
  shell:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obesity-ml-shell
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    command: bash
    stdin_open: true
    tty: true
    networks:
      - ml-network
    profiles:
      - dev

# ============================================================================
# NETWORKS & VOLUMES
# ============================================================================

networks:
  ml-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  data:
    driver: local
  models:
    driver: local
  reports:
    driver: local
  mlruns:
    driver: local